const { SlashCommandBuilder } = require('discord.js');
const { getGuild } = require('hypixel-api-reborn');
const GuildSettings = require('../../models/GuildSettings');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('link-guild')
        .setDescription('üîó –ü—Ä–∏–≤—è–∑–∞—Ç—å Hypixel –≥–∏–ª—å–¥–∏—é –∫ —Å–µ—Ä–≤–µ—Ä—É')
        .addStringOption(option =>
            option.setName('name')
                .setDescription('–ù–∞–∑–≤–∞–Ω–∏–µ Hypixel –≥–∏–ª—å–¥–∏–∏')
                .setRequired(true)
        ),

    async execute(interaction) {
        const guildName = interaction.options.getString('name');
        await interaction.deferReply({ ephemeral: true });

        try {
            const guild = await getGuild('name', guildName, { key: process.env.HYPIXEL_API_KEY });
            if (!guild || !guild.id || !guild.name || !guild.ranks) {
                return interaction.editReply('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≥–∏–ª—å–¥–∏–∏. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∏–º—è —É–∫–∞–∑–∞–Ω–æ –≤–µ—Ä–Ω–æ.');
            }

            const update = {
                $push: {
                    linkedGuilds: {
                        hypixelGuildId: guild.id,
                        hypixelGuildName: guild.name,
                        guildRanks: guild.ranks.slice(0,4),
                        roles: {
                            guildMemberRole: null,
                            rankRoles: {
                                rank1: null,
                                rank2: null,
                                rank3: null,
                                rank4: null
                            }
                        }
                    }
                }
            };

            await GuildSettings.findOneAndUpdate(
                { discordGuildId: interaction.guild.id },
                update,
                { upsert: true }
            );

            return interaction.editReply(`‚úÖ –ì–∏–ª—å–¥–∏—è **${guild.name}** —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É!`);
        } catch (err) {
            console.error(err);
            return interaction.editReply('‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–≤—è–∑–∫–µ –≥–∏–ª—å–¥–∏–∏.');
        }
    }
};
